<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Sleeve Collection Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #6798A3 0%, #236271 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        h1 {
            color: #02313C;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .feature-badge {
            display: inline-block;
            background: linear-gradient(135deg, #3D7886 0%, #236271 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-top: 10px;
            font-weight: 600;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #3D7886;
            border-bottom-color: #3D7886;
            font-weight: bold;
        }

        .tab:hover {
            color: #3D7886;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 3px dashed #3D7886;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f0f5f7;
        }

        .upload-area:hover {
            border-color: #236271;
            background: #e8f0f3;
        }

        .upload-area.dragover {
            background: #e0ebef;
            border-color: #236271;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        input[type="file"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #3D7886;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f0f5f7;
            border-radius: 8px;
            border: 2px solid #e0ebef;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .info-text {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        button {
            background: linear-gradient(135deg, #3D7886 0%, #236271 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(61, 120, 134, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-bar input {
            flex: 1;
        }

        .tag-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tag-chip {
            padding: 8px 16px;
            background: #e0ebef;
            border: 2px solid #3D7886;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            color: #3D7886;
        }

        .tag-chip:hover,
        .tag-chip.active {
            background: #3D7886;
            color: white;
        }

        .preview-container {
            margin: 20px 0;
            padding: 20px;
            background: #f0f5f7;
            border-radius: 10px;
            border: 2px solid #e0ebef;
            display: none;
        }

        .preview-container.active {
            display: block;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .preview-label {
            font-weight: 600;
            color: #3D7886;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }


        .card-image {
            width: 100%;
            /* Card ratio: 2.5 / 3.5 = 5 / 7 */
            aspect-ratio: 5 / 7;
            object-fit: cover;
            background: #f0f0f0;
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            /* Ensure the card flexes naturally with the aspect-ratio image */
            display: flex;
            flex-direction: column;
        }

        .card-body {
            padding: 15px;
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .card-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .tag {
            background: none;
            color: #3D7886;
            padding: 0;
            border-radius: 0;
            font-size: 11px;
            font-weight: 400;
        }

        .card-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-bottom: 8px;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
            flex: 1;
        }

        .btn-delete {
            background: linear-gradient(135deg, #104A58 0%, #02313C 100%);
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3D7886;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .similar-image {
            width: 100%;
            /* Keep ratio consistent with the rest of the app */
            aspect-ratio: 5 / 7;
            object-fit: cover;
            display: block;
        }

        .similar-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            transition: border-color 0.3s;
        }

        .similar-card:hover {
            border-color: #3D7886;
        }

        .similar-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .similar-info {
            padding: 8px;
            font-size: 12px;
            text-align: center;
            background: #f8f9ff;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Layout for side-by-side preview in Edit Modal */
        .edit-preview-layout {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .edit-image-container {
            flex: 1;
            text-align: center;
        }

        #edit-preview.preview-container {
            flex: 1;
            margin: 0; /* Remove top/bottom margin to align with the left image */
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîê Admin - Pokemon Sleeve Collection</h1>
            <p class="subtitle">Add new sleeves, check for duplicates, and manage your collection</p>
            <div style="margin-top: 15px;">
                <span class="feature-badge">‚ú® Auto Crop & Straighten</span>
                <a href="/" class="feature-badge" style="text-decoration: none; margin-left: 10px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">üè† Public View</a>
                <a href="/gallery" class="feature-badge" style="text-decoration: none; margin-left: 10px; background: linear-gradient(135deg, #3D7886 0%, #236271 100%);">üñºÔ∏è Gallery View</a>
            </div>
        </header>

        <div class="controls">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('add', event)">Add New</button>
                <button class="tab" onclick="switchTab('check', event)">Check Duplicate</button>
            </div>

            <!-- Add New Tab -->
            <div id="add-tab" class="tab-content active">
                <form id="upload-form" onsubmit="return false;">
                    <div class="upload-area" id="drop-area">
                        <p style="font-size: 48px; margin-bottom: 10px;">üì§</p>
                        <p style="font-size: 18px; color: #3D7886; margin-bottom: 10px;">Click to upload or drag and drop</p>
                        <p style="color: #999; font-size: 14px;">PNG, JPG, GIF, WEBP (Max 16MB)</p>
                        <input type="file" id="file-input" accept="image/*" style="display: none;">
                    </div>

                    <div id="upload-preview" class="preview-container">
                        <div class="preview-label">
                            <span>‚úÖ Preview (Processed)</span>
                        </div>
                        <img id="upload-preview-img" class="preview-image" alt="Preview">
                    </div>

                    <div id="upload-duplicate-results" style="display: none; margin-top: 15px;"></div>

                    <div class="form-group">
                        <label for="name-input">Sleeve Name</label>
                        <input type="text" id="name-input" placeholder="e.g., Pikachu Ultra Pro Sleeves">
                    </div>

                    <div class="form-group">
                        <label for="description-input">Description</label>
                        <textarea id="description-input" placeholder="Add any notes or details about this sleeve..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="tags-input">Tags (space-separated, # will be added automatically)</label>
                        <input type="text" id="tags-input" placeholder="e.g., pikachu yellow ultra-pro electric">
                    </div>

                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px; margin: 0; cursor: pointer; font-weight: normal;">
                            <input type="checkbox" id="auto-process-upload" style="width: auto; margin: 0;">
                            <span>Auto-crop and straighten</span>
                        </label>
                        <button type="submit" onclick="uploadImage()">Add to Collection</button>
                        <label style="display: flex; align-items: center; gap: 5px; margin: 0; cursor: pointer; font-weight: normal;">
                            <input type="checkbox" id="add-another" checked style="width: auto; margin: 0;">
                            <span>Add another</span>
                        </label>
                    </div>
                </form>
            </div>

            <!-- Check Duplicate Tab -->
            <div id="check-tab" class="tab-content">
                <div class="upload-area" id="check-drop-area">
                    <p style="font-size: 48px; margin-bottom: 10px;">üîç</p>
                    <p style="font-size: 18px; color: #3D7886; margin-bottom: 10px;">Upload an image to check for duplicates</p>
                    <p style="color: #999; font-size: 14px;">This will search your collection for similar images</p>
                    <input type="file" id="check-file-input" accept="image/*" style="display: none;">
                </div>

                <div style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" id="auto-process-check" checked style="width: auto; margin: 0;">
                        <span>Auto-crop and straighten for better comparison</span>
                    </label>
                </div>

                <div id="check-preview" class="preview-container">
                    <div class="preview-label">
                        <span>‚úÖ Processed Image</span>
                    </div>
                    <img id="check-preview-img" class="preview-image" alt="Preview">
                </div>

                <div id="duplicate-results"></div>
            </div>
        </div>

        <div class="controls" style="margin-top: 30px;">
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Search by name, description, or tags...">
                <button onclick="searchCollection()">Search</button>
                <button onclick="clearSearch()">Clear</button>
            </div>

            <div id="tag-filter-container" class="tag-filter"></div>

            <div id="collection-stats" style="margin-bottom: 15px; color: #666;"></div>
        </div>

        <div id="message-container"></div>

        <div id="gallery" class="gallery">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading collection...</p>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Sleeve</h2>
                <button class="close-modal" onclick="closeEditModal()">√ó</button>
            </div>
            <form id="edit-form" onsubmit="return false;">
                <input type="hidden" id="edit-id">
                <input type="hidden" id="edit-filename">

                <div class="edit-preview-layout">
                    <div class="edit-image-container">
                        <div class="preview-label">Current Sleeve</div>
                        <img id="edit-current-image" style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);" alt="Current image">
                    </div>

                    <div id="edit-preview" class="preview-container">
                        <div class="preview-label">
                            <span>‚úÖ Processed Preview</span>
                        </div>
                        <img id="edit-preview-img" class="preview-image" style="max-height: 300px;" alt="Processed preview">
                    </div>
                </div>

                <!-- Image Adjustment Controls -->
                <div style="margin: 20px 0; padding: 15px; background: #f0f5f7; border-radius: 8px; border: 1px solid #3D7886;">
                    <h3 style="margin: 0 0 15px 0; color: #02313C; font-size: 16px;">Image Adjustments</h3>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #02313C; font-weight: 500;">Brightness</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="edit-brightness" min="-100" max="100" value="0" step="1"
                                   style="flex: 1;" oninput="updateEditImageTransform()">
                            <span id="edit-brightness-value" style="min-width: 50px; text-align: right; color: #3D7886; font-weight: 500;">0</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #02313C; font-weight: 500;">Contrast</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="edit-contrast" min="-100" max="100" value="0" step="1"
                                   style="flex: 1;" oninput="updateEditImageTransform()">
                            <span id="edit-contrast-value" style="min-width: 50px; text-align: right; color: #3D7886; font-weight: 500;">0</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #02313C; font-weight: 500;">Rotation</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button type="button" onclick="rotateEditImage(-0.5)"
                                    style="padding: 8px 15px; background: linear-gradient(135deg, #3D7886 0%, #236271 100%); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">
                                ‚Ü∫ -0.5¬∞
                            </button>
                            <input type="number" id="edit-rotation" value="0" step="0.5" min="-360" max="360"
                                   style="flex: 1; padding: 8px; border: 1px solid #3D7886; border-radius: 5px; text-align: center;"
                                   onchange="updateEditImageTransform()" oninput="updateEditImageTransform()">
                            <button type="button" onclick="rotateEditImage(0.5)"
                                    style="padding: 8px 15px; background: linear-gradient(135deg, #3D7886 0%, #236271 100%); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">
                                ‚Üª +0.5¬∞
                            </button>
                        </div>
                    </div>

                    <button type="button" onclick="resetEditImageTransform()"
                            style="width: 100%; padding: 8px; background: #104A58; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">
                        Reset Adjustments
                    </button>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" id="edit-auto-process" onchange="processEditImage()" style="width: auto; margin: 0;">
                        <span>Auto-crop and straighten</span>
                    </label>
                </div>

                <div class="form-group">
                    <label for="edit-name">Name</label>
                    <input type="text" id="edit-name">
                </div>
                <div class="form-group">
                    <label for="edit-description">Description</label>
                    <textarea id="edit-description"></textarea>
                </div>
                <div class="form-group">
                    <label for="edit-tags">Tags (space-separated, # will be added automatically)</label>
                    <input type="text" id="edit-tags">
                </div>
                <button onclick="saveEdit()">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Duplicate Confirmation Modal -->
    <div id="duplicate-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö†Ô∏è Similar Sleeve Found</h2>
                <button class="close-modal" onclick="closeDuplicateModal()">√ó</button>
            </div>
            <p style="margin-bottom: 20px; color: #856404;">This image appears to already be in your collection:</p>
            <div id="duplicate-card-container" style="margin-bottom: 20px;"></div>
            <div style="display: flex; gap: 10px;">
                <button onclick="addAnyway()" style="flex: 1; background: linear-gradient(135deg, #3D7886 0%, #236271 100%);">Add Anyway</button>
                <button onclick="closeDuplicateModal()" style="flex: 1; background: linear-gradient(135deg, #104A58 0%, #02313C 100%);">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let allImages = [];
        let currentFilter = '';
        let currentTag = '';
        let processedImageData = null;
        let pendingUploadData = null;

        // Tab switching
        function switchTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Find and activate the correct tab button
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(tab => {
                if (tab.textContent.toLowerCase().includes(tabName)) {
                    tab.classList.add('active');
                }
            });

            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // File upload drag and drop
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const checkDropArea = document.getElementById('check-drop-area');
        const checkFileInput = document.getElementById('check-file-input');

        [dropArea, checkDropArea].forEach(area => {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                area.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                area.addEventListener(eventName, () => area.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                area.addEventListener(eventName, () => area.classList.remove('dragover'), false);
            });
        });

        dropArea.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
            previewUploadImage();
        }, false);

        checkDropArea.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            checkFileInput.files = files;
            previewCheckImage();
        }, false);

        dropArea.addEventListener('click', () => fileInput.click());
        checkDropArea.addEventListener('click', () => checkFileInput.click());
        fileInput.addEventListener('change', previewUploadImage);
        checkFileInput.addEventListener('change', previewCheckImage);

        // Real-time tag processing
        function formatTagsInput(inputElement) {
            const cursorPos = inputElement.selectionStart;
            const value = inputElement.value;

            // Split by spaces, process each word, preserve spaces
            const parts = value.split(/(\s+)/);
            let formatted = '';
            let charCount = 0;
            let newCursorPos = cursorPos;

            for (let i = 0; i < parts.length; i++) {
                const part = parts[i];
                if (part.trim() && !part.match(/^\s+$/)) {
                    // It's a tag word - format it
                    let processed = part.replace(/^#+/, '').trim().toLowerCase();
                    if (processed) {
                        processed = '#' + processed;
                        formatted += processed;
                        const partStart = charCount;
                        const partEnd = charCount + part.length;
                        // Adjust cursor if it was within this part
                        if (cursorPos >= partStart && cursorPos <= partEnd) {
                            // Cursor was in this word, place it at the end of formatted word
                            newCursorPos = formatted.length;
                        } else if (cursorPos > partEnd) {
                            // Cursor was after this part, adjust by length difference
                            newCursorPos += (processed.length - part.length);
                        }
                        charCount += part.length;
                    } else {
                        formatted += part;
                        charCount += part.length;
                    }
                } else {
                    // It's whitespace - keep it
                    formatted += part;
                    charCount += part.length;
                }
            }

            inputElement.value = formatted;
            // Ensure cursor is within bounds
            newCursorPos = Math.max(0, Math.min(newCursorPos, formatted.length));
            inputElement.setSelectionRange(newCursorPos, newCursorPos);
        }

        // Setup real-time tag formatting for input fields
        function setupTagFormatting(inputId) {
            const inputElement = document.getElementById(inputId);
            if (!inputElement) return;

            inputElement.addEventListener('input', function(e) {
                // Format when space is typed or text is pasted
                if (e.inputType === 'insertText' && e.data === ' ') {
                    setTimeout(() => formatTagsInput(this), 0);
                } else if (e.inputType === 'insertFromPaste') {
                    setTimeout(() => formatTagsInput(this), 0);
                }
            });

            inputElement.addEventListener('paste', function(e) {
                setTimeout(() => formatTagsInput(this), 0);
            });

            inputElement.addEventListener('keyup', function(e) {
                // Format after space key is released
                if (e.key === ' ' || e.key === 'Spacebar') {
                    formatTagsInput(this);
                }
            });
        }

        // Setup formatting for tag inputs when page loads
        setupTagFormatting('tags-input');

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Preview upload image
        async function previewUploadImage() {
            const fileInput = document.getElementById('file-input');
            const previewContainer = document.getElementById('upload-preview');
            const previewImg = document.getElementById('upload-preview-img');
            const autoProcess = document.getElementById('auto-process-upload').checked;
            const duplicateResultsDiv = document.getElementById('upload-duplicate-results');

            if (!fileInput.files[0]) {
                previewContainer.classList.remove('active');
                if (duplicateResultsDiv) {
                    duplicateResultsDiv.style.display = 'none';
                    duplicateResultsDiv.innerHTML = '';
                }
                window.uploadDuplicateInfo = null;
                return;
            }

            // Clear previous duplicate results when new file is selected
            if (duplicateResultsDiv) {
                duplicateResultsDiv.style.display = 'none';
                duplicateResultsDiv.innerHTML = '';
            }
            window.uploadDuplicateInfo = null;

            if (autoProcess) {
                // Process the image
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                try {
                    const response = await fetch('/api/process-image', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success && data.processed) {
                        previewImg.src = data.image_data;
                        processedImageData = data.image_data;
                        previewContainer.classList.add('active');
                        showMessage('‚ú® Image processed! Ready to add.', 'info');
                        // Check for duplicates after processing
                        checkUploadDuplicate();
                    } else {
                        // Show original image
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            previewImg.src = e.target.result;
                            processedImageData = null;
                            previewContainer.classList.add('active');
                            // Check for duplicates after image loads
                            checkUploadDuplicate();
                        };
                        reader.readAsDataURL(fileInput.files[0]);

                        if (data.message) {
                            showMessage(data.message, 'info');
                        }
                    }
                } catch (error) {
                    showMessage('Error processing image: ' + error.message, 'error');
                }
            } else {
                // Just show original
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    processedImageData = null;
                    previewContainer.classList.add('active');
                    // Check for duplicates after image loads
                    checkUploadDuplicate();
                };
                reader.readAsDataURL(fileInput.files[0]);
            }
        }

        // Check for duplicates in upload form
        async function checkUploadDuplicate() {
            const fileInput = document.getElementById('file-input');
            const duplicateResultsDiv = document.getElementById('upload-duplicate-results');
            const autoProcess = document.getElementById('auto-process-upload').checked;

            if (!fileInput.files[0]) {
                if (duplicateResultsDiv) duplicateResultsDiv.style.display = 'none';
                return;
            }

            if (!duplicateResultsDiv) return;
            duplicateResultsDiv.style.display = 'block';
            duplicateResultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Checking for duplicates...</p></div>';

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('auto_process', autoProcess);

            try {
                const response = await fetch('/api/check-duplicate', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                // Store duplicate info for upload function
                window.uploadDuplicateInfo = data;

                if (data.is_duplicate) {
                    duplicateResultsDiv.innerHTML = `
                        <div class="message warning">
                            <strong>‚ö†Ô∏è Duplicate Found!</strong><br>
                            ${data.message}<br>
                            <small>You can still add this image if needed.</small>
                        </div>
                        <div class="similar-images" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 15px;">
                            ${data.similar_images.slice(0, 3).map(img => `
                                <div class="similar-card">
                                    <img src="/collection/${img.filename}" alt="Similar" class="similar-image">
                                    <div class="similar-info">
                                        Match: ${Math.round((10 - img.distance) / 10 * 100)}%
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else if (data.similar_images.length > 0) {
                    duplicateResultsDiv.innerHTML = `
                        <div class="message info">
                            <strong>‚ÑπÔ∏è Similar Images Found</strong><br>
                            ${data.message}<br>
                            Found ${data.similar_images.length} somewhat similar image${data.similar_images.length > 1 ? 's' : ''}.
                        </div>
                        <div class="similar-images" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 15px;">
                            ${data.similar_images.slice(0, 3).map(img => `
                                <div class="similar-card">
                                    <img src="/collection/${img.filename}" alt="Similar" class="similar-image">
                                    <div class="similar-info">
                                        Match: ${Math.round((10 - img.distance) / 10 * 100)}%
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    // Hide the duplicate results div when no duplicates found
                    duplicateResultsDiv.style.display = 'none';
                    duplicateResultsDiv.innerHTML = '';
                }
            } catch (error) {
                duplicateResultsDiv.innerHTML = `<div class="message error">Error checking duplicate: ${error.message}</div>`;
            }
        }

        // Preview check image
        async function previewCheckImage() {
            const fileInput = document.getElementById('check-file-input');
            const previewContainer = document.getElementById('check-preview');
            const previewImg = document.getElementById('check-preview-img');
            const autoProcess = document.getElementById('auto-process-check').checked;

            if (!fileInput.files[0]) {
                previewContainer.classList.remove('active');
                return;
            }

            if (autoProcess) {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                try {
                    const response = await fetch('/api/process-image', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success && data.processed) {
                        previewImg.src = data.image_data;
                        previewContainer.classList.add('active');
                    } else {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            previewImg.src = e.target.result;
                            previewContainer.classList.add('active');
                        };
                        reader.readAsDataURL(fileInput.files[0]);
                    }
                } catch (error) {
                    console.error('Error processing image:', error);
                }
            } else {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    previewContainer.classList.add('active');
                };
                reader.readAsDataURL(fileInput.files[0]);
            }

            // Also check for duplicates
            checkForDuplicate();
        }

        // Load collection
        async function loadCollection() {
            try {
                const response = await fetch('/api/collection');
                const data = await response.json();
                allImages = data.images;
                displayGallery(allImages);
                updateStats(data.total);
                loadTags();
            } catch (error) {
                showMessage('Error loading collection: ' + error.message, 'error');
            }
        }

        // Display gallery
        function displayGallery(images) {
            const gallery = document.getElementById('gallery');

            if (images.length === 0) {
                gallery.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <p style="font-size: 64px;">üé¥</p>
                        <h3 style="margin-bottom: 10px;">No sleeves yet!</h3>
                        <p>Start building your collection by adding some Pokemon card sleeves.</p>
                    </div>
                `;
                return;
            }

            gallery.innerHTML = images.map(img => `
                <div class="card">
                    <img src="/collection/${img.filename}" alt="${img.name || 'Pokemon Sleeve'}" class="card-image">
                    <div class="card-body">
                        <div class="card-title">${img.name || img.original_filename}</div>
                        ${img.description ? `<div class="card-description">${img.description}</div>` : ''}
                        ${img.tags && img.tags.length > 0 ? `
                            <div class="card-tags">
                                ${img.tags.map((tag, tagIndex) => `<span class="tag">${tag}${tagIndex < img.tags.length - 1 ? ',' : ''}</span>`).join(' ')}
                            </div>
                        ` : ''}
                        <div class="card-actions">
                            <button class="btn-small" onclick="openEditModal('${img.id}')">Edit</button>
                            <button class="btn-small btn-delete" onclick="deleteImage('${img.id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Process tags: lowercase and add # prefix if missing
        function processTags(tagString) {
            if (!tagString || !tagString.trim()) return [];
            return tagString
                .split(/\s+/)
                .filter(t => t.trim())
                .map(tag => {
                    // Remove any existing # and trim
                    let processed = tag.replace(/^#+/, '').trim().toLowerCase();
                    // Add # prefix
                    return '#' + processed;
                })
                .filter(t => t.length > 1); // Filter out just "#"
        }

        // Upload image
        async function uploadImage(forceDuplicate = false) {
            const fileInput = document.getElementById('file-input');
            const name = document.getElementById('name-input').value;
            const description = document.getElementById('description-input').value;
            const tagsInput = document.getElementById('tags-input').value;
            const tags = processTags(tagsInput);
            const autoProcess = document.getElementById('auto-process-upload').checked;

            if (!fileInput.files[0]) {
                showMessage('Please select an image file', 'error');
                return;
            }

            // If duplicate was detected during preview, automatically force upload
            if (window.uploadDuplicateInfo && window.uploadDuplicateInfo.is_duplicate && !forceDuplicate) {
                forceDuplicate = true;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('name', name);
            formData.append('description', description);
            formData.append('tags', tags.join(' '));
            formData.append('auto_process', autoProcess);
            if (forceDuplicate) {
                formData.append('force_duplicate', 'true');
            }

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.status === 409 && !forceDuplicate) {
                    // Store the pending upload data
                    pendingUploadData = { fileInput, name, description, tags, autoProcess };

                    // Show duplicate modal with the similar image
                    showDuplicateModal(data.similar);
                    return;
                }

                if (response.ok) {
                    showMessage('‚úÖ ' + data.message, 'success');
                    document.getElementById('upload-form').reset();
                    document.getElementById('upload-preview').classList.remove('active');
                    const duplicateResultsDiv = document.getElementById('upload-duplicate-results');
                    if (duplicateResultsDiv) {
                        duplicateResultsDiv.style.display = 'none';
                        duplicateResultsDiv.innerHTML = '';
                    }
                    window.uploadDuplicateInfo = null;
                    loadCollection();

                    // Check if "add another" is checked
                    const addAnother = document.getElementById('add-another').checked;

                    // Reset the add-another checkbox to checked state
                    document.getElementById('add-another').checked = true;

                    // Only switch to browse if not adding another
                    if (!addAnother) {
                        switchTab('browse');
                    }
                } else {
                    showMessage('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Upload failed: ' + error.message, 'error');
            }
        }

        // Show duplicate modal
        function showDuplicateModal(similar) {
            const container = document.getElementById('duplicate-card-container');
            const img = allImages.find(i => i.id === similar.id);

            if (img) {
                container.innerHTML = `
                    <div class="card" style="max-width: 400px; margin: 0 auto;">
                        <img src="/collection/${img.filename}" alt="${img.name || 'Sleeve'}" class="card-image">
                        <div class="card-body">
                            <div class="card-title">${img.name || img.original_filename}</div>
                            ${img.description ? `<div class="card-description">${img.description}</div>` : ''}
                            ${img.tags && img.tags.length > 0 ? `
                                <div class="card-tags">
                                    ${img.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="text-align: center;">
                        <img src="/collection/${similar.filename}" alt="Similar" style="max-width: 300px; border-radius: 8px;">
                        <p style="margin-top: 10px;">Similarity: ${Math.round((10 - similar.distance) / 10 * 100)}%</p>
                    </div>
                `;
            }

            document.getElementById('duplicate-modal').classList.add('active');
        }

        // Close duplicate modal
        function closeDuplicateModal() {
            document.getElementById('duplicate-modal').classList.remove('active');
            pendingUploadData = null;
        }

        // Add anyway
        async function addAnyway() {
            closeDuplicateModal();
            // Retry upload with force flag
            await uploadImage(true);
        }

        // Check for duplicate
        async function checkForDuplicate() {
            const fileInput = document.getElementById('check-file-input');
            const resultsDiv = document.getElementById('duplicate-results');
            const autoProcess = document.getElementById('auto-process-check').checked;

            if (!fileInput.files[0]) {
                return;
            }

            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Checking for duplicates...</p></div>';

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('auto_process', autoProcess);

            try {
                const response = await fetch('/api/check-duplicate', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.is_duplicate) {
                    resultsDiv.innerHTML = `
                        <div class="message warning">
                            <strong>‚ö†Ô∏è Duplicate Found!</strong><br>
                            ${data.message}
                        </div>
                        <div class="similar-images">
                            ${data.similar_images.map(img => `
                                <div class="similar-card">
                                    <img src="/collection/${img.filename}" alt="Similar" class="similar-image">
                                    <div class="similar-info">
                                        Match: ${Math.round((10 - img.distance) / 10 * 100)}%
                                        ${img.tags.length > 0 ? `<br>${img.tags.slice(0, 2).join(', ')}` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else if (data.similar_images.length > 0) {
                    resultsDiv.innerHTML = `
                        <div class="message success">
                            <strong>‚úÖ No Exact Duplicate</strong><br>
                            ${data.message}<br>
                            Found ${data.similar_images.length} somewhat similar images:
                        </div>
                        <div class="similar-images">
                            ${data.similar_images.map(img => `
                                <div class="similar-card">
                                    <img src="/collection/${img.filename}" alt="Similar" class="similar-image">
                                    <div class="similar-info">
                                        Match: ${Math.round((10 - img.distance) / 10 * 100)}%
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="message success">
                            <strong>‚úÖ No Similar Images</strong><br>
                            This appears to be a new, unique sleeve design!
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="message error">Error checking duplicate: ${error.message}</div>`;
            }
        }

        // Delete image
        async function deleteImage(id) {
            if (!confirm('Are you sure you want to delete this sleeve?')) {
                return;
            }

            try {
                const response = await fetch(`/api/image/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Sleeve deleted successfully', 'success');
                    loadCollection();
                } else {
                    showMessage('Error deleting sleeve', 'error');
                }
            } catch (error) {
                showMessage('Delete failed: ' + error.message, 'error');
            }
        }

        // Edit modal
        // Image transformation state
        let editImageOriginalSrc = null;

        function openEditModal(id) {
            const image = allImages.find(img => img.id === id);
            if (!image) return;

            document.getElementById('edit-id').value = id;
            document.getElementById('edit-filename').value = image.filename;
            document.getElementById('edit-name').value = image.name || '';
            document.getElementById('edit-description').value = image.description || '';
            // Display tags with # prefix
            document.getElementById('edit-tags').value = (image.tags || []).join(' ');
            document.getElementById('edit-auto-process').checked = false;
            document.getElementById('edit-preview').classList.remove('active');

            // Reset image adjustments
            document.getElementById('edit-brightness').value = 0;
            document.getElementById('edit-brightness-value').textContent = '0';
            document.getElementById('edit-contrast').value = 0;
            document.getElementById('edit-contrast-value').textContent = '0';
            document.getElementById('edit-rotation').value = 0;

            // Display current image
            const imageUrl = `/collection/${image.filename}`;
            document.getElementById('edit-current-image').src = imageUrl;
            editImageOriginalSrc = imageUrl;

            // Setup formatting for edit-tags if not already set up
            const editTagsInput = document.getElementById('edit-tags');
            if (editTagsInput && !editTagsInput.dataset.formatted) {
                setupTagFormatting('edit-tags');
                editTagsInput.dataset.formatted = 'true';
            }

            // Reset image transform
            updateEditImageTransform();

            document.getElementById('edit-modal').classList.add('active');
        }

        function updateEditImageTransform() {
            const img = document.getElementById('edit-current-image');
            const brightness = parseFloat(document.getElementById('edit-brightness').value);
            const contrast = parseFloat(document.getElementById('edit-contrast').value);
            const rotation = parseFloat(document.getElementById('edit-rotation').value);

            // Update value displays
            document.getElementById('edit-brightness-value').textContent = brightness;
            document.getElementById('edit-contrast-value').textContent = contrast;

            // Apply CSS filters and transforms
            // Brightness: 0% = black, 100% = normal, 200% = white (so 0 = -100%, 100 = 0%, 200 = +100%)
            const brightnessPercent = 100 + brightness;
            // Contrast: 0% = gray, 100% = normal, 200% = high contrast (so 0 = -100%, 100 = 0%, 200 = +100%)
            const contrastPercent = 100 + contrast;

            img.style.filter = `brightness(${brightnessPercent}%) contrast(${contrastPercent}%)`;
            img.style.transform = `rotate(${rotation}deg)`;
        }

        function rotateEditImage(degrees) {
            const rotationInput = document.getElementById('edit-rotation');
            const currentRotation = parseFloat(rotationInput.value) || 0;
            const newRotation = currentRotation + degrees;
            rotationInput.value = newRotation;
            updateEditImageTransform();
        }

        function resetEditImageTransform() {
            document.getElementById('edit-brightness').value = 0;
            document.getElementById('edit-contrast').value = 0;
            document.getElementById('edit-rotation').value = 0;
            updateEditImageTransform();
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        async function processEditImage() {
            const checked = document.getElementById('edit-auto-process').checked;
            const previewContainer = document.getElementById('edit-preview');
            const previewImg = document.getElementById('edit-preview-img');
            const filename = document.getElementById('edit-filename').value;

            if (!checked) {
                previewContainer.classList.remove('active');
                return;
            }

            try {
                // Fetch the current image and process it
                const response = await fetch(`/collection/${filename}`);
                const blob = await response.blob();
                const file = new File([blob], filename, { type: blob.type });

                const formData = new FormData();
                formData.append('file', file);

                const processResponse = await fetch('/api/process-image', {
                    method: 'POST',
                    body: formData
                });

                const data = await processResponse.json();

                if (data.success && data.processed) {
                    previewImg.src = data.image_data;
                    previewContainer.classList.add('active');
                    showMessage('‚ú® Preview generated!', 'info');
                } else {
                    showMessage(data.message || 'Could not process image', 'info');
                    document.getElementById('edit-auto-process').checked = false;
                }
            } catch (error) {
                showMessage('Error processing image: ' + error.message, 'error');
                document.getElementById('edit-auto-process').checked = false;
            }
        }

        async function saveEdit() {
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('edit-name').value;
            const description = document.getElementById('edit-description').value;
            const tagsInput = document.getElementById('edit-tags').value;
            const tags = processTags(tagsInput);
            const reprocess = document.getElementById('edit-auto-process').checked;

            // Get image adjustment values
            const brightness = parseFloat(document.getElementById('edit-brightness').value) || 0;
            const contrast = parseFloat(document.getElementById('edit-contrast').value) || 0;
            const rotation = parseFloat(document.getElementById('edit-rotation').value) || 0;

            // Only include adjustments if they're non-zero
            const adjustments = (brightness !== 0 || contrast !== 0 || rotation !== 0) ? {
                brightness,
                contrast,
                rotation
            } : null;

            try {
                const response = await fetch(`/api/image/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, description, tags, reprocess, adjustments })
                });

                if (response.ok) {
                    showMessage('Sleeve updated successfully', 'success');
                    closeEditModal();
                    loadCollection();
                } else {
                    showMessage('Error updating sleeve', 'error');
                }
            } catch (error) {
                showMessage('Update failed: ' + error.message, 'error');
            }
        }

        // Search and filter
        function searchCollection() {
            currentFilter = document.getElementById('search-input').value;
            applyFilters();
        }

        function clearSearch() {
            currentFilter = '';
            currentTag = '';
            document.getElementById('search-input').value = '';
            document.querySelectorAll('.tag-chip').forEach(chip => chip.classList.remove('active'));
            displayGallery(allImages);
            updateStats(allImages.length);
        }

        function filterByTag(tag) {
            currentTag = currentTag === tag ? '' : tag;
            applyFilters();

            document.querySelectorAll('.tag-chip').forEach(chip => {
                chip.classList.toggle('active', chip.textContent === tag && currentTag);
            });
        }

        async function applyFilters() {
            try {
                let url = '/api/collection?';
                if (currentFilter) url += `search=${encodeURIComponent(currentFilter)}&`;
                if (currentTag) url += `tag=${encodeURIComponent(currentTag)}`;

                const response = await fetch(url);
                const data = await response.json();
                displayGallery(data.images);
                updateStats(data.total);
            } catch (error) {
                showMessage('Error filtering collection: ' + error.message, 'error');
            }
        }

        async function loadTags() {
            try {
                const response = await fetch('/api/tags');
                const data = await response.json();
                const container = document.getElementById('tag-filter-container');

                if (data.tags.length > 0) {
                    container.innerHTML = '<strong>Filter by tag:</strong> ' +
                        data.tags.map(tag =>
                            `<span class="tag-chip" onclick="filterByTag('${tag}')">${tag}</span>`
                        ).join('');
                } else {
                    container.innerHTML = '';
                }
            } catch (error) {
                console.error('Error loading tags:', error);
            }
        }

        function updateStats(count) {
            document.getElementById('collection-stats').textContent =
                `Showing ${count} sleeve${count !== 1 ? 's' : ''}`;
        }

        // Show message
        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = message;
            container.appendChild(messageEl);

            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }

        // Load collection on page load
        loadCollection();
    </script>
</body>
</html>
